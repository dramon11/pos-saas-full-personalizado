export async function handleSales(request, env) {
  const url = new URL(request.url);
  const path = url.pathname;

  if (request.method === 'POST' && path === '/api/sales') {
    const body = await request.json();
    const { user_id, items, total, company_id } = body;

    const result = await env.DB.prepare(
      'INSERT INTO sales (user_id, total, company_id) VALUES (?, ?, ?)'
    )
      .bind(user_id, total, company_id)
      .run();

    const saleId = result.meta.last_row_id;

    for (const item of items) {
      await env.DB.prepare(
        'INSERT INTO sale_items (sale_id, product_id, quantity, price) VALUES (?, ?, ?, ?)'
      )
        .bind(saleId, item.product_id, item.quantity, item.price)
        .run();

      // Actualizar stock
      await env.DB.prepare(
        'UPDATE products SET stock = stock - ? WHERE id = ?'
      )
        .bind(item.quantity, item.product_id)
        .run();
    }

    return new Response(JSON.stringify({ success: true, saleId }), {
      headers: { 'Content-Type': 'application/json' },
    });
  }

  return new Response('Ruta no encontrada', { status: 404 });
}