export async function handleAuth(request, env) {
  const url = new URL(request.url);
  const path = url.pathname;

  if (request.method === 'POST' && path === '/auth/login') {
    const body = await request.json();
    const { email, password } = body;

    const user = await env.DB.prepare(
      'SELECT id, email, role, company_id FROM users WHERE email = ? AND password = ?'
    )
      .bind(email, password)
      .first();

    if (!user) {
      return new Response(JSON.stringify({ error: 'Credenciales incorrectas' }), {
        status: 401,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    const sessionId = crypto.randomUUID();
    await env.SESSIONS.put(sessionId, JSON.stringify(user), { expirationTtl: 86400 });

    return new Response(JSON.stringify({ token: sessionId, user }), {
      headers: { 'Content-Type': 'application/json' },
    });
  }

  return new Response('Ruta no encontrada', { status: 404 });
}